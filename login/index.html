---
layout: layouts/public.njk
title: Login | ValueAlign
permalink: /login/
meta_description: Sign in to your ValueAlign account and continue your journey towards value-aligned living.
pageTitle: Log In to ValueAlign
eleventyNavigation:
  key: Login
  order: 90
---

<section class="py-16 md:py-24">
  <div class="container mx-auto px-6">
    <div class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
      <div class="p-6">
        <div class="text-center mb-6">
          <h1 class="text-2xl font-bold text-va-text dark:text-white font-montserrat">Welcome Back</h1>
          <p class="text-gray-600 dark:text-gray-400">Sign in to continue your journey</p>
        </div>

        <!-- Auth Canvas Container -->
        <div id="auth-canvas-container" class="my-6" aria-live="polite">
          <!-- Auth canvas will be loaded here -->
          <div class="auth-loading text-center py-6">
            <p class="text-gray-600 dark:text-gray-400 mb-4">Loading login form...</p>
            <div class="flex justify-center">
              <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          </div>

          <!-- Fallback login form -->
          <form id="login-form-fallback" class="hidden space-y-4">
            <!-- Error message area -->
            <div id="login-message" class="rounded-md p-4 hidden" role="alert">
              <p class="text-sm" id="login-message-text"></p>
            </div>
              
              <div class="rounded-md space-y-6">
                <div>
                  <label for="email" class="sr-only">Email address</label>
                  <input id="email" name="email" type="email" autocomplete="email" required
                         class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-va-text dark:text-white focus:outline-none focus:ring-va-primary dark:focus:ring-green-500 focus:border-va-primary dark:focus:border-green-500 focus:z-10 sm:text-sm dark:bg-gray-700"
                         placeholder="Email address" aria-required="true" aria-invalid="false">
                  <p id="email-error" class="mt-1 text-sm text-red-600 dark:text-red-400 hidden"></p>
                </div>
                <div>
                  <label for="password" class="sr-only">Password</label>
                  <input id="password" name="password" type="password" autocomplete="current-password" required
                         class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-va-text dark:text-white focus:outline-none focus:ring-va-primary dark:focus:ring-green-500 focus:border-va-primary dark:focus:border-green-500 focus:z-10 sm:text-sm dark:bg-gray-700"
                         placeholder="Password" aria-required="true" aria-invalid="false">
                  <p id="password-error" class="mt-1 text-sm text-red-600 dark:text-red-400 hidden"></p>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <input id="remember-me" name="remember-me" type="checkbox" 
                         class="h-4 w-4 text-va-primary focus:ring-va-primary border-gray-300 rounded dark:border-gray-600 dark:bg-gray-700"
                         aria-describedby="remember-me-description">
                  <label for="remember-me" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Remember me</label>
                  <span id="remember-me-description" class="sr-only">Keep me signed in for 30 days</span>
                </div>
                <a href="/forgot-password/" class="text-sm text-va-primary dark:text-va-primary-light hover:underline">Forgot password?</a>
              </div>
              <div>
                <button id="login-button" type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-va-primary hover:bg-green-700 dark:bg-va-primary-light dark:text-gray-900 dark:hover:bg-green-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-va-primary">
                  <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                    <svg class="h-5 w-5 text-emerald-500 group-hover:text-emerald-400 dark:text-gray-900" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                    </svg>
                  </span>
                  <span>Sign in</span>
                  <span id="loading-spinner" class="ml-2 hidden">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  </span>
                </button>
              </div>
            </div>
          </form>
        </div>

        <div class="text-center pt-4 border-t border-gray-200 dark:border-gray-700">
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Don't have an account?
            <a href="/signup/" class="text-va-primary dark:text-va-primary-light hover:underline">Sign up</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Status message for screen readers -->
<div id="login-status" class="sr-only" role="status" aria-live="polite"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[LoginController] Initializing login page');
    
    // DOM elements
    const authContainer = document.getElementById('auth-canvas-container');
    const loadingElement = authContainer.querySelector('.auth-loading');
    const fallbackForm = document.getElementById('login-form-fallback');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const messageDiv = document.getElementById('login-message');
    const messageText = document.getElementById('login-message-text');
    const emailError = document.getElementById('email-error');
    const passwordError = document.getElementById('password-error');
    const submitButton = fallbackForm.querySelector('button[type="submit"]');
    const loadingSpinner = document.getElementById('loading-spinner');
    const statusElement = document.getElementById('login-status');
    
    // Attempt to initialize auth canvas
    function initializeAuthCanvas() {
      if (window.AuthService && typeof window.AuthService.renderLoginForm === 'function') {
        // Use the AuthService to render the login form
        try {
          window.AuthService.renderLoginForm(authContainer);
          statusElement.textContent = 'Login form loaded';
          loadingElement.classList.add('hidden');
        } catch (error) {
          console.error('[LoginController] Error rendering login form:', error);
          showFallbackForm();
        }
      } else {
        console.error('[LoginController] AuthService not available or missing renderLoginForm method');
        showFallbackForm();
      }
    }
    
    // Show fallback form if dynamic loading fails
    function showFallbackForm() {
      loadingElement.classList.add('hidden');
      fallbackForm.classList.remove('hidden');
      statusElement.textContent = 'Using basic login form';
      
      // Set up fallback form submission
      // Pre-populate email if remembered
      if (window.authService && window.authService.authState && window.authService.authState.rememberMe && 
          window.authService.authState.user && window.authService.authState.user.email) {
        emailInput.value = window.authService.authState.user.email;
        rememberMeCheckbox.checked = true;
      }
      
      fallbackForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Clear previous error messages
        hideErrors();
        
        const email = emailInput.value;
        const password = passwordInput.value;
        const rememberMe = rememberMeCheckbox.checked;
        
        // Basic validation
        let hasErrors = false;
        
        if (!email) {
          showFieldError('email', 'Please enter your email address');
          hasErrors = true;
        } else if (!isValidEmail(email)) {
          showFieldError('email', 'Please enter a valid email address');
          hasErrors = true;
        }
        
        if (!password) {
          showFieldError('password', 'Please enter your password');
          hasErrors = true;
        }
        
        if (hasErrors) {
          return;
        }
        
        // Show loading state
        submitButton.disabled = true;
        loadingSpinner.classList.remove('hidden');
        statusElement.textContent = 'Logging in, please wait...';
        
        // Attempt login with auth service
        if (window.authService) {
          if (typeof window.authService.login === 'function') {
            window.authService.login(email, password, rememberMe)
              .then(user => {
                // Check if there's a redirect URL stored
                const redirectUrl = localStorage.getItem('auth_redirect_after_login') || '/dashboard/';
                localStorage.removeItem('auth_redirect_after_login');
                
                // Check if the user's email is verified
                if (user.emailVerified === false) {
                  // Show verification reminder and redirect after a delay
                  showMessage('Login successful. Please verify your email for full access.', 'warning');
                  statusElement.textContent = 'Login successful. Please verify your email.';
                  
                  setTimeout(() => {
                    window.location.href = '/verify-email/';
                  }, 2000);
                } else {
                  // Regular login success
                  showMessage('Login successful! Redirecting...', 'success');
                  statusElement.textContent = 'Login successful. Redirecting to dashboard.';
                  
                  setTimeout(() => {
                    window.location.href = redirectUrl;
                  }, 1000);
                }
              })
              .catch(error => {
                submitButton.disabled = false;
                loadingSpinner.classList.add('hidden');
                showMessage('Login failed: ' + error.message, 'error');
                statusElement.textContent = 'Login failed: ' + error.message;
              });
          } else if (typeof window.authService.authenticateUser === 'function') {
            // Legacy method
            window.authService.authenticateUser(email, password, rememberMe);
          } else {
            // Default fallback
            showMessage('Authentication service is not properly initialized. Please try again later.', 'error');
            submitButton.disabled = false;
            loadingSpinner.classList.add('hidden');
          }
        } else {
          console.error('[LoginController] Auth service not available');
          showMessage('Authentication service is not available. This is a demo.', 'error');
          
          // For the demo, we'll simulate login after a delay
          setTimeout(() => {
            submitButton.disabled = false;
            loadingSpinner.classList.add('hidden');
            showMessage('Demo login successful! Redirecting...', 'success');
            
            setTimeout(() => {
              window.location.href = '/dashboard/';
            }, 1000);
          }, 1500);
        }
      });
    }
    
    // Helper function to validate email format
    function isValidEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email.toLowerCase());
    }
    
    // Helper function to show field-level error
    function showFieldError(field, message) {
      const errorElement = document.getElementById(`${field}-error`);
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');
        document.getElementById(field).setAttribute('aria-invalid', 'true');
      }
    }
    
    // Helper function to hide all errors
    function hideErrors() {
      if (emailError) {
        emailError.textContent = '';
        emailError.classList.add('hidden');
        emailInput.setAttribute('aria-invalid', 'false');
      }
      
      if (passwordError) {
        passwordError.textContent = '';
        passwordError.classList.add('hidden');
        passwordInput.setAttribute('aria-invalid', 'false');
      }
      
      if (messageDiv) {
        messageDiv.classList.add('hidden');
      }
    }
    
    // Helper function to show message
    function showMessage(message, type = 'info') {
      if (!messageDiv || !messageText) return;
      
      messageText.textContent = message;
      messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-800');
      
      if (type === 'success') {
        messageDiv.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-100');
      } else if (type === 'error') {
        messageDiv.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
      } else if (type === 'warning') {
        messageDiv.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-800', 'dark:text-yellow-100');
      } else {
        messageDiv.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-800', 'dark:text-blue-100');
      }
    }
    
    // Check if AuthService is already available
    if (window.AuthService) {
      initializeAuthCanvas();
    } else {
      // Wait for AuthService to load
      window.addEventListener('authServiceReady', initializeAuthCanvas);
      
      // Fallback if auth service doesn't initialize within reasonable time
      setTimeout(() => {
        if (loadingElement.classList.contains('hidden')) {
          // Auth canvas was initialized, do nothing
          return;
        }
        showFallbackForm();
      }, 3000);
    }
  });
</script>
